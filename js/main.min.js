const AUTHOR_NAME="Korosium";const image_input=document.getElementById("image-input");const canvas_output=document.getElementById("canvas-output");const ctx=canvas_output.getContext("2d");const img=new Image();const reverse_check=document.getElementById("reverse-check");const download_black_white=document.getElementById("download-black-white");const white_range=document.getElementById("white-range");const white_range_value=document.getElementById("white-range-value");const generate_braille=document.getElementById("generate-braille");const copy_braille=document.getElementById("copy-braille");const download_braille=document.getElementById("download-braille");const text_output=document.getElementById("text-output");image_input.onchange=()=>{show_image_in_black_and_white(white_range.value,reverse_check.checked);};reverse_check.onchange=()=>{show_image_in_black_and_white(white_range.value,reverse_check.checked);white_range_value.innerHTML=white_range.value;};download_black_white.onclick=()=>{if(image_input.files.length===0)return;download_url(canvas_output.toDataURL(),generate_filename(image_input.files[0].name,".png"));};white_range.oninput=()=>{show_image_in_black_and_white(white_range.value,reverse_check.checked);white_range_value.innerHTML=white_range.value;};generate_braille.onclick=()=>{text_output.innerHTML=img_to_braille(ctx,img);};copy_braille.onclick=()=>{const braille=text_output.innerHTML;navigator.clipboard.writeText(braille.substring(0,braille.length-1));};download_braille.onclick=()=>{if(image_input.files.length===0)return;const braille=text_output.innerHTML;const data_url=window.URL.createObjectURL(new Blob([new TextEncoder().encode(braille.substring(0,braille.length-1))]));download_url(data_url,generate_filename(image_input.files[0].name,".txt"));};const get_braille_character=()=>{let retval=[];let arr=[226,160,128];const td=new TextDecoder();for(let i=0;i<256;i++){const c=td.decode(new Uint8Array(arr).buffer);retval[retval.length]=c;arr[arr.length-1]++;if(arr[arr.length-1]%64===0){arr[arr.length-1]=128;arr[arr.length-2]++;}}return retval;};const image_data_to_grayscale=(ctx,img)=>{let retval=ctx.getImageData(0,0,img.width,img.height);for(let i=0;i<retval.data.length;i+=4){let avg=((retval.data[i]+retval.data[i+1]+retval.data[i+2])/3)&0xff;retval.data[i]=avg;retval.data[i+1]=avg;retval.data[i+2]=avg;retval.data[i+3]=0xff;}return retval;};const image_data_to_black_and_white=(ctx,img,reversed,whitePoint=0x80)=>{let retval=ctx.getImageData(0,0,img.width,img.height);let white=0xff;let black=0x00;if(reversed){white=0x00;black=0xff;}for(let i=0;i<retval.data.length;i+=4){let col=black;if(retval.data[i]>whitePoint)col=white;retval.data[i]=col;retval.data[i+1]=col;retval.data[i+2]=col;retval.data[i+3]=0xff;}return retval;};const show_image_in_black_and_white=(whitePoint,reversed)=>{if(image_input.value==="")return;const fr=new FileReader();fr.readAsDataURL(image_input.files[0]);fr.onload=()=>{img.src=fr.result;img.onload=()=>{const ratio=480/img.width;canvas_output.width=img.width;canvas_output.height=img.height;canvas_output.style.width=`${parseInt(img.width * ratio)}px`;canvas_output.style.height=`${parseInt(img.height * ratio)}px`;ctx.drawImage(img,0,0);ctx.putImageData(image_data_to_grayscale(ctx,img),0,0);ctx.putImageData(image_data_to_black_and_white(ctx,img,reversed,whitePoint),0,0);};img.onerror=()=>{console.log(fr.error);}};fr.onerror=()=>{console.log(fr.error);}};const get_binary_pixel_data=(ctx,x,y)=>{let data=ctx.getImageData(x,y,2,4).data;let retval=[];for(let i=0;i<data.length;i+=4){retval[i/4]=data[i]&1;}return retval;};const img_to_braille=(ctx,img)=>{const braille=get_braille_character();let retval="";for(let y=0;y<img.height;y+=4){for(let x=0;x<img.width;x+=2){const temp=get_binary_pixel_data(ctx,x,y);let n=(temp[7]<<7)|(temp[6]<<6)|(temp[5]<<5)|(temp[3]<<4)|(temp[1]<<3)|(temp[4]<<2)|(temp[2]<<1)|temp[0];if(n===0)n=128;retval+=braille[n];}retval+="\n";console.clear();console.log(`${((y / img.height * 100) & 0xff)}%`);}if(img.width<100){text_output.style.width=img.width+"ch";text_output.style.marginLeft="auto";text_output.style.marginRight="auto";}else{text_output.style.width="";text_output.style.marginLeft="";text_output.style.marginRight="";}return retval;};const generate_filename=(filename,extension)=>{const filename_no_extension=filename.substring(0,filename.lastIndexOf("."));const white_point=parseInt(white_range_value.innerHTML).toString(8).padStart(3,"0");const reversed=0+reverse_check.checked;return`${reversed}${white_point}-${filename_no_extension}${extension}`};const download_url=(url,name)=>{let a=window.document.createElement('a');a.href=url;a.download=name;a.click();URL.revokeObjectURL(a.href);a=null;};const init=()=>{image_input.value="";reverse_check.checked=false;white_range.value=0x7f;white_range_value.innerHTML=white_range.value;canvas_output.style.width="0px";canvas_output.style.height="0px";document.getElementsByTagName("footer")[0].innerHTML+=`<p>Copyright ${new Date().getFullYear()} ${AUTHOR_NAME}</p>`;};const main=()=>{init();};window.onload=main;